rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users collection - users can read/write their own data
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Profiles collection - users can read their own, only server can write
    match /profiles/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if false; // Only server-side agents can write
    }
    
    // Polls collection - public read, authenticated write
    match /polls/{pollId} {
      allow read: if true; // Public read
      allow write: if request.auth != null; // Authenticated users can create polls
    }
    
    // Verifications collection - users can read their own verifications
    match /verifications/{verificationId} {
      allow read: if request.auth != null && 
                     (resource.data.wallet == request.auth.uid || 
                      request.resource.data.wallet == request.auth.uid);
      // Only server-side API can write verifications
      allow write: if false; // Handled by API routes
    }
    
    // Completions collection - users can write their own, read their own or poll creator
    match /completions/{completionId} {
      allow read: if request.auth != null && 
                     (resource.data.uid == request.auth.uid || 
                      resource.data.creator_uid == request.auth.uid);
      allow write: if request.auth != null && 
                      request.resource.data.uid == request.auth.uid;
    }
    
    // Payout logs - only readable by owner or creator, only server can write
    match /payout_logs/{logId} {
      allow read: if request.auth != null && 
                     (resource.data.uid == request.auth.uid || 
                      resource.data.creator_uid == request.auth.uid);
      allow write: if false; // Only server-side agents
    }
    
    // Datasets - readable by buyers/sellers, writable by creators
    match /datasets/{datasetId} {
      allow read: if request.auth != null && 
                     (resource.data.creator_uid == request.auth.uid || 
                      resource.data.buyer_uid == request.auth.uid);
      allow write: if request.auth != null && 
                      request.resource.data.creator_uid == request.auth.uid;
    }
    
    // Purchases - readable by buyer or admin
    match /purchases/{purchaseId} {
      allow read: if request.auth != null && 
                     resource.data.buyer_uid == request.auth.uid;
      allow write: if false; // Only server-side agents
    }
    
    // Logs - only server can access
    match /logs/{document=**} {
      allow read, write: if false; // Server-only
    }
  }
}
